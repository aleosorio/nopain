---
title: "Zingtree Visualizations"
author: "MAO"
date: "27-06-2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Librerías:
```{r, message = FALSE}
library(tidyverse)
library(jsonlite)
library(magrittr)
```

## I. Obteniendo Datos de Zingtree

### I.a. Detalle de sesiones (session_id) por rango de fechas

- **Nombre de consulta API**: agent_sessions
- **Estructura de consulta API**:
'https://zingtree.com/api/agent_sessions/{{apikey}}/{{agent}}/{{dateini}}/{{datefin}}'

Parámetros de consulta:
```{r}
apikey <- "4c92e2fd3f24f25d02308f6b8d7dd53c"
agent <- "*"
dateini <- "2022-02-21"
datefin <- "2022-02-25"
```

Importando desde URL Zingtree, las variables "session_id", "start_time" (renombrándola "session_date") y "agent" del dataframe "sessions", desde la lista fuente:
```{r, message = FALSE}
agent_sessions <- fromJSON(txt = str_c("https://zingtree.com/api/agent_sessions/", apikey, "/", agent, "/", dateini, "/", datefin)) %>%
  .$sessions %>%
  select(., session_id, session_date = start_time, agent) %>%
  as_tibble(.)
```

Eliminando hora y dejando sólo la fecha de la variable "session_date".  Luego cambiando a formato 'date':
```{r message = FALSE}
agent_sessions$session_date <- str_sub(agent_sessions$session_date, 1, 10) %>%
  as.Date(.)
```

Dataframe obtenida:
```{r, echo = TRUE}
head(agent_sessions, 5)
```

### I.b. Data de sesiones por session_id (de consulta anterior)

- **Nombre de consulta API**: get_form_data
- **Estructura de consulta API**:
https://zingtree.com/api/session/{{session_id}}/get_form_data

#### I.b.i. Función de extracción de un registro para un sesion_id

- **Variable**: session_id
- **Input**: JSON de Zingtree
- **Output**: Tibble con 1 registro

```{r}

get_form_data <- function(session_id) {
  fromJSON(txt = str_c("https://zingtree.com/api/session/", session_id, "/get_form_data")) %>%
    as_tibble(.)
}
```

#### I.b.ii. Tibble para un registro (reg), en base a tibbles CritMov, Sympt_Diagn_Sol y TGs

Tibble inicial, en base a una sola sesión:
```{r}
reg <- 1
session_data <- get_form_data(agent_sessions$session_id[reg]) %>%
  select(., order(colnames(.))) %>%
  mutate(., Session = agent_sessions$session_id[reg], .before = colnames(.)[1])
```

Crit_Mov:
```{r}
numcritmov <- session_data %>%
  colnames(.) %>%
  str_subset(., "CritMov") %>%
  length(.)

if (numcritmov > 0) {
  crit_mov <- session_data %>%
      select(., -(starts_with("Sympt_Diagn_Sol") | starts_with("TG"))) %>%
      gather(., which(str_starts(colnames(.), "CritMov")), key = "CritMov", value = "CritMov_Value") %>%
      mutate(., Rama = str_sub(CritMov, start =9, end =11), .after = Session)
} else {
  crit_mov <- session_data %>%
    mutate(., CritMov = "", CritMov_Value = "") %>%
    mutate(., Rama = "", .after = Session)
}
```

Sympt_Diagn_Sol:
```{r}
numsympt <- session_data %>%
  colnames(.) %>%
  str_subset(., "Sympt_Diagn_Sol") %>%
  length(.)

if (numsympt > 0) {
  sympt_diagn_sol <- session_data %>%
      select(., Session, starts_with("Sympt_Diagn_Sol")) %>%
      gather(., which(str_starts(colnames(.), "Sympt_Diagn_Sol")), key = "Sympt_Diagn_Sol", value = "Sympt_Diagn_Sol_Value") %>%
      mutate(., Rama = str_sub(Sympt_Diagn_Sol, start = 17, end = 19), .after = Session)
} else {
  sympt_diagn_sol <- tibble(Session = session_data$Session[[1]], Sympt_Diagn_Sol = "", Sympt_Diagn_Sol_Value = "") %>%
    mutate(., Rama = "", .after = Session)
}
```

TG - gestos: Vector de nombres de session_data, que contengan "TG" y terminen con un número (ej: TG_1_1_1)
```{r}
gestos <- session_data %>%
  colnames(.) %>%
  str_subset(., "TG") %>%
  str_subset(., "[:digit:]$")
```

TG - zonas: Vector con patrones de gestos, en base a primeros 5 digitos iguales (ej: TG1_1)
```{r}
zonas <- gestos %>%
  str_sub(., start = 1, end = 5) %>%
  unique(.)
```

TG - Tibble: Sesión con vectores de gestos anidados, en base a zonas (ej de un vector: TG1_1_1, TG1_1_2, etc.).
```{r}
numzonas <- length(zonas)

if (numzonas > 0) {
  TG <- tibble()
  for(i in 1:length(zonas)) {
      TGloop <- session_data %>%
            select(., Session, str_subset(gestos, zonas[i])) %>%
            mutate(., Rama = str_sub(zonas[[i]], start = 3, end = 5), .after = Session) %>%
            pivot_longer(., cols = colnames(.[3:ncol(.)]), names_to = "TG", values_to = "TG_Val") %>%
            nest(., TGs = 3:4)
        TG <- bind_rows(TG, TGloop)
  }
} else {
  TG <- tibble(Session = session_data$Session[[1]], Rama = "", TGs = list(tibble(TG = "", TG_Val = "")))
}
```

Tibble final, en base a inner_join de tablas crit_mov, sympt_diagn_sol y TG:
```{r}
session_tibble <- inner_join(crit_mov, sympt_diagn_sol, by = c("Session", "Rama")) %>%
  inner_join(., TG, by = c("Session", "Rama"))
```



