---
title: "Zingtree Visualizations"
author: "MAO"
date: "27-06-2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Librerías:
```{r, message = FALSE}
library(tidyverse)
library(jsonlite)
library(magrittr)
```

## I. Obteniendo Datos de Zingtree

### I.a. Detalle de sesiones (session_id) por rango de fechas

- **Nombre de consulta API**: agent_sessions
- **Estructura de consulta API**:
'https://zingtree.com/api/agent_sessions/{{apikey}}/{{agent}}/{{dateini}}/{{datefin}}'

Parámetros de consulta:
```{r}
apikey <- "4c92e2fd3f24f25d02308f6b8d7dd53c"
agent <- "*"
dateini <- "2022-02-14"
datefin <- "2022-02-15"
```

Importando desde URL Zingtree, las variables "session_id", "start_time" (renombrándola "session_date") y "agent" del dataframe "sessions", desde la lista fuente:
```{r, message = FALSE}
agent_sessions <- fromJSON(txt = str_c("https://zingtree.com/api/agent_sessions/", apikey, "/", agent, "/", dateini, "/", datefin)) %>%
  .$sessions %>%
  select(., session_id, session_date = start_time, agent) %>%
  as_tibble(.)
```

Eliminando hora y dejando sólo la fecha de la variable "session_date".  Luego cambiando a formato 'date':
```{r message = FALSE}
agent_sessions$session_date <- str_sub(agent_sessions$session_date, 1, 10) %>%
  as.Date(.)
```

Dataframe obtenida:
```{r, echo = TRUE}
str(agent_sessions, 5)
```

### I.b. Data de sesiones por session_id (de consulta anterior)

- **Nombre de consulta API**: get_form_data
- **Estructura de consulta API**:
https://zingtree.com/api/session/{{session_id}}/get_form_data

#### I.b.i. Función de extracción de un registro para un sesion_id

- **Variable**: session_id
- **Input**: JSON de Zingtree
- **Output**: Tibble con 1 registro

```{r}

get_form_data <- function(session_id) {
  fromJSON(txt = str_c("https://zingtree.com/api/session/", session_id, "/get_form_data")) %>%
    as_tibble(.)
}
```

#### I.b.ii. Confexión de Tibble en base a detalle de sesiones en agent_sessions, mediante función get_form_data

Confexión del tibble
```{r}
form_data <- tibble()
for(i in 1:nrow(agent_sessions)) {
  form_data <- bind_rows(form_data, get_form_data(agent_sessions$session_id[i]))
}
```

Limpieza de campos NA del Tibble
```{r}
form_data[is.na(form_data)] <- ""
```

Ordenamiento alfabético de columnas del Tibble
```{r}
form_data <- select(form_data, order(colnames(form_data)))
head(form_data, 5)
```


